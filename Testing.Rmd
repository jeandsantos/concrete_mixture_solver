---
title: "Testing"
author: "App developed by [Jean Dos Santos](https://www.linkedin.com/in/jeandsantos/)"
date: "07/01/2020"
output: 
  bookdown::html_document2:
    code_folding: hide
    df_print: paged
    highlight: tango
    number_sections: yes
    rows.print: 10
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, error = FALSE, warning = FALSE, comment = NA, fig.align = 'center')
```
# Load Packages

```{r, warning=FALSE, message=FALSE, error=FALSE}
# if(!require(shiny)) {install.packages("shiny")} else {require(shiny)}
# if(!require(shinythemes)) {install.packages("shinythemes")} else {require(shinythemes)}
if(!require(GA)) {install.packages("GA")} else {require(GA)}
if(!require(tidyverse)) {install.packages("tidyverse")} else {require(tidyverse)}
if(!require(caret)) {install.packages("caret")} else {require(caret)}
if(!require(knitr)) {install.packages("knitr")} else {require(knitr)}
# if(!require(DT)) {install.packages("DT")} else {require(DT)}
# if(!require(nnet)) {install.packages("nnet")} else {require(nnet)}
# if(!require(parallel)) {install.packages("parallel")} else {require(parallel)}

library(tictoc)
```


# Import Data

```{r}
features_ID <- c("Cement", "Slag", "Ash", "Water", "Superplasticizer", "Coarse_Aggregate", "Fine_Aggregate", "Age", "Strength")
features_title <- c("Cement", "Blast Furncace Slag", "Fly Ash", "Water", "Superplasticizer", "Coarse Aggregate", "Fine Aggregate", "Age (days)", "Strength (MPa)")
predictors_ID <- c("Cement", "Slag", "Ash", "Water", "Superplasticizer", "Coarse_Aggregate", "Fine_Aggregate")
age_selected <- 28 # Days of aging

# Import model
if(!exists("model_strength")) {model_strength <- base::readRDS("Models/avNNet_model.rds")}

# Import Functions
base::source("helpers/eval_function_with_limits.R")
base::source("helpers/GA_summary_plot.R")
message(Sys.time(),": Supporting functions imported")
```

```{r}
Cement_range <- c(0.04, 0.25)
Ash_range <- c(0.0, 0.10)
Coarse_Aggregate_range <- c(0.30, 0.55)
Fine_Aggregate_range <- c(0.20, 0.45)
Slag_range <- c(0.0, 0.20)
Superplasticizer_range <- c(0.0, 0.01)
Water_range <- c(0.05, 0.12)

limits_GA <- data_frame(
       Cement_min = Cement_range[1],
       Cement_max = Cement_range[2],
       Ash_min = Ash_range[1],
       Ash_max = Ash_range[2],
       Coarse_Aggregate_min = Coarse_Aggregate_range[1],
       Coarse_Aggregate_max = Coarse_Aggregate_range[2],
       Fine_Aggregate_min = Fine_Aggregate_range[1],
       Fine_Aggregate_max = Fine_Aggregate_range[2],
       Slag_min = Slag_range[1],
       Slag_max = Slag_range[2],
       Superplasticizer_min = Superplasticizer_range[1],
       Superplasticizer_max = Superplasticizer_range[2],
       Water_min = Water_range[1],
       Water_max = Water_range[2],
       )

min_limits_GA <- data_frame(
       Cement = Cement_range[1],
       Ash = Ash_range[1],
       Coarse_Aggregate = Coarse_Aggregate_range[1],
       Fine_Aggregate = Fine_Aggregate_range[1],
       Slag = Slag_range[1],
       Superplasticizer = Superplasticizer_range[1],
       Water = Water_range[1]
       )

max_limits_GA <- data_frame(
       Cement = Cement_range[2],
       Ash = Ash_range[2],
       Coarse_Aggregate = Coarse_Aggregate_range[2],
       Fine_Aggregate = Fine_Aggregate_range[2],
       Slag = Slag_range[2],
       Superplasticizer = Superplasticizer_range[2],
       Water = Water_range[2]
       )

mid_values_GA <- data_frame(
       Cement = mean(Cement_range),
       Ash = mean(Ash_range),
       Coarse_Aggregate = mean(Coarse_Aggregate_range),
       Fine_Aggregate = mean(Fine_Aggregate_range),
       Slag = mean(Slag_range),
       Superplasticizer = mean(Superplasticizer_range),
       Water = mean(Water_range)
       )

limits_GA
min_limits_GA
max_limits_GA
mid_values_GA
```

```{r}
Cement = mid_values_GA["Cement"]
Ash = mid_values_GA["Ash"]
Coarse_Aggregate = mid_values_GA["Coarse_Aggregate"]
Fine_Aggregate = mid_values_GA["Fine_Aggregate"]
Slag = mid_values_GA["Slag"]
Superplasticizer = mid_values_GA["Superplasticizer"]
Water = mid_values_GA["Water"]
Age = 28

input_data <- tibble(
  Cement = Cement[[1]],
  Ash = Ash[[1]],
  Coarse_Aggregate = Coarse_Aggregate[[1]],
  Fine_Aggregate = Fine_Aggregate[[1]],
  Slag = Slag[[1]],
  Superplasticizer = Superplasticizer[[1]],
  Water = Water[[1]],
  Age = Age[[1]]
)
```

# `eval_function`

```{r}
GA_output <- GA::ga(type = "real-valued",
               fitness = function(x) { eval_function_with_limits(x[1], x[2], x[3], x[4], x[5], x[6], 
                                                                 min_limits_GA = min_limits_GA, 
                                                                 max_limits_GA = max_limits_GA, 
                                                                 Age = Age) },
               names = c("Cement", "Ash", "Coarse Aggregate", "Fine Aggregate", "Slag", "Superplasticizer"),
               lower = c(min_limits_GA$Cement, min_limits_GA$Ash, 
                         min_limits_GA$Coarse_Aggregate, min_limits_GA$Fine_Aggregate, 
                         min_limits_GA$Slag, min_limits_GA$Superplasticizer), 
               upper = c(max_limits_GA$Cement, max_limits_GA$Ash, 
                         max_limits_GA$Coarse_Aggregate, max_limits_GA$Fine_Aggregate, 
                         max_limits_GA$Slag, max_limits_GA$Superplasticizer),
               popSize = 10, 
               maxiter = 5, 
               optim = FALSE, 
               seed = 1, 
               parallel = FALSE,
               keepBest = FALSE,
               updatePop = FALSE,
               monitor = FALSE
               )
```



The optimization algorithm found a concrete mixture with a compressive strength of `r round(GA_output@fitnessValue, 3)` MPa after `r GA_output@iter` iterations.

# Solution

```{r}
tibble(
    Strength = GA_output@fitnessValue,
    Age = Age,
    Cement = round(GA_output@solution[1, "Cement"]*100, 3),
    Ash = round(GA_output@solution[1, "Ash"]*100, 3),
    Coarse_Aggregate = round(GA_output@solution[1, "Coarse Aggregate"]*100, 3),
    Fine_Aggregate = round(GA_output@solution[1, "Fine Aggregate"]*100, 3),
    Slag = round(GA_output@solution[1, "Slag"]*100, 3),
    Superplasticizer = round(GA_output@solution[1, "Superplasticizer"]*100, 3),
    Water = round((1 - sum(GA_output@solution[1,]))*100, 3),
    .name_repair = ~ c("Strength (MPa)",
                       "Age (days)", 
                       "Cement (%)", 
                       "Ash (%)", 
                       "Coarse Aggregate (%)", 
                       "Fine Aggregate (%)", 
                       "Slag (%)", 
                       "Superplasticizer (%)", 
                       "Water (%)"
                       )
) %>% t() %>% as.data.frame() %>% knitr::kable(format = "markdown", digits = 3, align = "c", col.names = "Values", label = "Result of optimization algorithm.")
```

```{r}
GA::plot.ga(GA_output)
```



# Search Parameters

```{r}
tibble(
    Component = paste(GA_output@names, "(%)"),
    `Lower Limits` = GA_output@lower*100,
    `Upper Limits` = GA_output@upper*100,
    `Solution` = round(GA_output@solution[1, ]*100, 3)) %>% 
  mutate(`Abides Limits` = if_else((`Solution` <= `Upper Limits`) & (`Solution` >= `Lower Limits`), TRUE, FALSE)) %>% 
  kable(row.names = TRUE, format = "markdown", align = "lcccc", digits = 3, label = "Limits used for inputs of optimization algorithm.")
```

```{r}
tibble(
  `Population Size` = GA_output@popSize,
  `Number of iterations` = GA_output@iter,
  `Maximum number of iterations` = GA_output@maxiter,
  `Probability of Crossover` = GA_output@pcrossover,
  `Probability of Mutation` = GA_output@pmutation,
  `Elitism (%)` = GA_output@elitism,
  `Run` = GA_output@run, 
  `Perform local optimization` = GA_output@optim) %>% 
  t() %>% 
  kable(col.names = "Setting", format = "markdown", digits = 2, align = "lc", label = "Settings of optimization algorithm.")
```



```{r}
GA_output
```

***

# Additional Information

```{r}
Sys.info()
```

```{r}
sessionInfo()
```









































































































